# Look for handler, "ansible.builtin.debug", register
---
- name: "Setting up NetworkManager configuration"
  hosts: localhost
  tasks:
    - name: "Setting up IPv6 Privacy Extension"
      become: true
      copy:
        content: |
          [connections]
          ipv6.ip6-privacy=2
        dest: /etc/NetworkManager/conf.d/10-ip6-privacy.conf
        force: false
      notify: Reload NetworkManager
  handlers:
    - name: Reload NetworkManager
      become: true
      command: nmcli general reload
      notify: Disable networking

    - name: Disable networking
      command: nmcli networking off
      notify: Enable networking

    - name: Enable networking
      command: nmcli networking on
      notify: Wait for network to start
    # FIX: This prints empty lines in playbook's output screen. Figure out how to remove it (or add a loading animation if possible)
    - name: Wait for network to start
      command: nmcli networking connectivity
      register: connectivity
      until: connectivity.stdout == "full"

- name: Setting up DNF packages
  hosts: localhost
  become: true
  tasks:
    - name: Removing packaes
      dnf:
        name:
          - nano
          - hplip
          - firefox
          - xarchiver
        state: absent
    - name: Swapping Fedora Release Packages for Sway's
      dnf:
        name:
          - fedora-release-sway
          - fedora-release-identity-sway
        state: latest
        allowerasing: true
    - name: Installing packages
      dnf:
        name:
          - nvim
          - fish
          - flatpak
          - toolbox
          - git
          - stow
        state: latest
    - name: Upgrade all packages
      dnf:
        name: "*"
        state: latest

- name: Setting Flatpak
  hosts: localhost
  tasks:
    - name: Installing Flatpak Package
      dnf:
        name: flatpak
        state: latest
    - name: Add Flathub as Flatpak Repo
      flatpak_remote:
        name: flathub
        flatpakrepo_url: https://dl.flathub.org/repo/flathub.flatpakrepo
        method: user
    - name: Install Flatpaks from Flathub
      flatpak:
          name:
            - io.gitlab.librewolf-community
            - org.keepassxc.KeePassXC
            - org.mozilla.firefox
            - com.github.tchx84.Flatseal
            - io.freetubeapp.FreeTube
          method: user
          state: latest

- name: Disabling services/daemons
  hosts: localhost
  tasks:
    - name: Stop service shhd.socket
      service:
        name: sshd.socket
        enabled: false 
        state: stopped
    - name: Stop service sshd.service
      service:
        name: sshd.service
        enabled: false
        state: stopped

- name: Setting configuration
  hosts: localhost
  vars:
    dotfile_dir: "{{ playbook_dir }}"
    cache_stow_file: "{{ dotfile_dir }}/.cache_stow"
  tasks:
    - name: Check cache stow
      stat:
        path: "{{ cache_stow_file }}"
      register: cache_stow
    - name: Setting dotfiles
      when: not cache_stow.stat.exists
      block:
        - name: Deleting old config files
          file:
            path: "{{ item }}"
            state: absent
          loop:
            - "{{ ansible_env.HOME }}/.config"
            - "{{ ansible_env.HOME }}/.bashrc"
            - "{{ ansible_env.HOME }}/.bashrc.d"
            - "{{ ansible_env.HOME }}/.local/share/flatpak/overrides"
   
        - name: Installing Ansible Package
          become: true
          dnf:
            name: ansible
            state: latest
          register: ansible_installation

        - name: Run Stow
          command: stow --dir {{ dotfile_dir }} --target {{ ansible_env.HOME }} --verbose --dotfiles --no-folding dotfiles
          args:
            creates: "{{ cache_stow_file }}"
          notify: Cache Stow
          when: ansible_installation is succeeded
  
  handlers:
    - name: Cache Stow
      file:
        path: "{{ cache_stow_file }}"
        state: touch
...
